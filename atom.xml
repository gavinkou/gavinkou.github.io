<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[竹叶山人]]></title>
    <link href="//zysr.me//atom.xml" rel="self"/>
    <link href="//zysr.me//"/>
    <updated>2024-06-01T22:37:57+08:00</updated>
    <id>//zysr.me//</id>
            <author>
            <name><![CDATA[雲文]]></name>                    </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[恢复win11的默认快捷菜单]]></title>
            <link href="//zysr.me//win11恢复默认快捷菜单_2024_06_01.html"/>
            <updated>2024-06-01T08:00:00+08:00</updated>
            <id>//zysr.me//win11恢复默认快捷菜单_2024_06_01.html</id>
            <content type="html"><![CDATA[<p>着实不喜欢win11默认的快捷菜单，</p>

<p><img src="//s.zysr.me/img/2024-06-01/image-20240601222043301.png" alt="image-20240601222043301" /></p>

<p>那个"show more options"实在是繁琐，国内很多方案都已经过时了，好在<a href="https://answers.microsoft.com/en-us/windows/forum/all/restore-old-right-click-context-menu-in-windows-11/a62e797c-eaf3-411b-aeec-e460e6e5a82a">微软官方有解决方案</a>：</p>

<pre><code>reg.exe add "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" /f /ve
</code></pre>

<p>效果非常好。</p>

<p><img src="//s.zysr.me/img/2024-06-01/image-20240601221814716.png" alt="image-20240601221814716" /></p>

<p>如果想恢复win11风格的，使用下面的来恢复既可。</p>

<pre><code>reg.exe delete "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}" /f
</code></pre>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[谒委羽山大有宫]]></title>
            <link href="//zysr.me//谒委羽山大有宫_2024_04_06.html"/>
            <updated>2024-04-06T08:00:00+08:00</updated>
            <id>//zysr.me//谒委羽山大有宫_2024_04_06.html</id>
            <content type="html"><![CDATA[<p><img src="//s.zysr.me/img/2024-05-01/c89dd4bf1efcc55fa1d1079c0d1aa91.jpg" alt="c89dd4bf1efcc55fa1d1079c0d1aa91" /></p>

<p>撑破了缸</p>

<p>舀了一碗</p>

<p>倒在林里</p>

<p>又爬了一树</p>

<p>这春色</p>

<p>关不住</p>

<p><img src="//s.zysr.me/img/2024-05-01/2681c87ad5f50a133ff0ca27f259e16.jpg" alt="2681c87ad5f50a133ff0ca27f259e16" /></p>

<p><img src="//s.zysr.me/img/2024-05-01/45f4460b8b41af457d50fd548810ee3.jpg" alt="45f4460b8b41af457d50fd548810ee3" /></p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[论咳]]></title>
            <link href="//zysr.me//论咳_2024_04_06.html"/>
            <updated>2024-04-06T08:00:00+08:00</updated>
            <id>//zysr.me//论咳_2024_04_06.html</id>
            <content type="html"><![CDATA[<p>《素问·咳论》虽言肺胃五脏六腑皆可令咳，然治则不出长沙之论。</p>

<p>此咳沿袭旧咳方，病家不明医理，尚情有可原。</p>

<p>若医者见咳止咳，减烧退烧，则医之大过。</p>

<p><img src="//s.zysr.me/img/2024-05-01/18eb45461c04b91da99964006c44de4.jpg" alt="18eb45461c04b91da99964006c44de4" style="zoom:50%;" /></p>

<p><img src="//s.zysr.me/img/2024-05-01/0beae68318caa3fa8af879ed47dfa70.jpg" alt="0beae68318caa3fa8af879ed47dfa70" style="zoom: 33%;" /></p>

<p><img src="//s.zysr.me/img/2024-05-01/image-20240501141720810.png" alt="image-20240501141720810" style="zoom:50%;" /></p>

<p>医道不彰，病医双失。
若国医废习，举国覆巢，无有完卵。</p>

<p>国医之昌，首在国学之旺，
炁化得以复兴，医可与道合，
则国可安，身得治。</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[再论经方剂量]]></title>
            <link href="//zysr.me//再论经方剂量_2024_02_21.html"/>
            <updated>2024-02-21T08:00:00+08:00</updated>
            <id>//zysr.me//再论经方剂量_2024_02_21.html</id>
            <content type="html"><![CDATA[<p>昨天忙了一下午，大汗淋漓，有点受凉，睡前吃药，今早很早就醒来，看见有关于“伤寒论一斤是多少”的讨论，因为引用的观点来自大名鼎鼎的大师章太炎，
伤寒论一两等于多少，
这是非常重大的问题，非常值得深入探讨和学习的。</p>

<p>能够验证张仲景所处的东汉衡制的实物“东汉大司农铜权”发掘于1981年。</p>

<p>章太炎先生卒于1936年，他的推断应该是只有文献基础而无实物佐证的，出现偏差也是正常。</p>

<p>考古出土的文物来看，以铜权实物来测算，汉制一斤约现在240g（约半斤，便于实操计算取250±10g），依汉制，一斤等于十六两，那么汉制一两≈250/16=15g， 邱光明、柯雪帆等人的研究也是基于此铜权，结论也是一样的，一两大约15±1g，当然也有很多人反对此东汉司农铜权的，认为这不合理，尤其是王莽新政引入诸多改革，这些改革影响东汉。</p>

<p><img src="http://s.zysr.me/img/2024-05-01/image-20240501123596456.webp" alt="邹城出土新莽度量衡" style="zoom:50%;" /></p>

<p><img src="//s.zysr.me/img/2024-02-21/88ef47e8254be9acccf3b403c3bcfab4.jpg" alt="88ef47e8254be9acccf3b403c3bcfab4" style="zoom: 67%;" /></p>

<p>随着出土的文物越来越多，尤其是最近的2018年，山东大学在邾国故城遗址，又发掘出来整整一套王莽新政时期的铜权（铜权四件，下图编号46-49），</p>

<p><img src="//s.zysr.me/img/2024-05-01/image-20240501190840684.png" alt="新莽铜权出土实物表" /></p>

<p>根据中国社会科学院考古研究所研究员白云翔的研究报告《邾国故城新莽铜诏版和铜环权简论》可以知道：<strong>250±10g</strong>为标准的铜权实物，时间上横跨整个西东两汉直也囊括王莽新政时期，可以说伴随着出土文物的强力证据的面世，“汉制一斤等于多少克”这个问题，在考古界，已经得到完美解决了。</p>

<p><img src="//s.zysr.me/img/2024-05-01/image-20240501192645480.png" alt="image-20240501192645480" /></p>

<p>汉制一斤为十六两，合今250±10克的话，折合为汉制<strong>一两为今15~16.25克之间</strong>。方便计，<strong>汉制一两折为15克</strong>，极为妥当。</p>

<p><img src="//s.zysr.me/img/2024-05-01/image-20240501193131171.png" alt="image-20240501193131171" /></p>

<p>剩下的就是医界如何推翻明清以来的医家一两约莫一钱等等个人解读，重回仲圣的原本剂量了。</p>

<p>尤其是因为药典的限制和医患关系的大的社会背景，这不单单是技术层面能够解决的问题。</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[最好的营养源是饭碗而不是药盒]]></title>
            <link href="//zysr.me//最好的营养源是饭碗而不是药盒_2024_01_01.html"/>
            <updated>2024-01-01T08:00:00+08:00</updated>
            <id>//zysr.me//最好的营养源是饭碗而不是药盒_2024_01_01.html</id>
            <content type="html"><![CDATA[<p><img src="//s.zysr.me/img/2024-01-01/image-20240101175127793.png" alt="image-20240101175127793" /></p>

<p>一位小朋友，37℃不算特别高， 但也是比正常水准略高。  <span class='quote'> 脾为生痰之源，肺为贮痰之器。</span>痰液粘粘不止，一定需要考虑饮食，这是为什么对于很多疾病都有的忌口，忌食生冷油腻等等， 不忌口就痰涎不断。</p>

<p>饮食不仅仅包括锅里来的，也包括药瓶来的。 现代生活远好过以前，丰富的日常饮食，足矣支撑人的活动。记得哈佛公共卫生学院对于日常摄入营养的介绍文章，有一个标题非常记忆深刻<span class='quote'>“Best source of vitamins? Your plate, not your medicine cabinet”</span>——<span class='emphasis'>“最好的营养源是饭碗而不是药盒”</span>，  不要再被那些广告、营养品商家营销洗脑。</p>

<p><img src="//s.zysr.me/img/2024-01-01/image-20240101175310771.png" alt="image-20240101175310771" /></p>

<p>说到饮食健康，强烈推荐<a href="https://www.health.harvard.edu/">哈佛大学公共卫生学院</a>的一系列文章，强烈推荐，这是在全球研究机构中，能够找到的研究深刻又适合大众阅读的资料。★★★★★  五星推荐。</p>

<p>说回，宝宝的情况，因为寒痰比较明显，其实最合适的方法是找中医开方，群中建议适合食疗或者OTC一类的话，那就解表的，比如说伤寒感冒颗粒，再加点藿香正气液， 伤寒感冒颗粒是主要解表散寒藿香正气液无非是利用它也有祛痰的功效。这段时间清单饮食为主，那些什么维生素补益剂暂停。病好之后再说。</p>

<pre><code class="comment">关于长期发汗啊什么的，确实会有发汗过度的问题，前面有位群友说的非常正确。
还有宝宝喜欢用安抚奶嘴的事情， 这的确容易掩盖问题源，但考虑到是两个宝宝的妈妈，又是早产，辛苦程度翻倍还不止，有个朋友单胎早产，十岁前几乎就是医院常客，虽然关系很好，但是不信中医爱莫能助，一定要在正确的方向来喂养宝宝，方向比努力重要。笔记那么详尽，在方向上正确的话，效用十倍。  
</code></pre>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[复杂的世界与发展的趋势以及应对的随机性]]></title>
            <link href="//zysr.me//复杂的世界与发展的趋势以及应对的随机性_2023_10_24.html"/>
            <updated>2023-10-24T20:41:00+08:00</updated>
            <id>//zysr.me//复杂的世界与发展的趋势以及应对的随机性_2023_10_24.html</id>
            <content type="html"><![CDATA[<p>看到一篇<a href="https://mp.weixin.qq.com/s/vMjqg61Jt4AOyxmHElaxGA">文章</a>，里面提到世界的复杂性，以及用随机性来处理的应对之法。</p>

<p>这个文章很有意思，   第一个是复杂问题的复杂度，和其决定因素。  现代社会越来越多的问题，其牵涉的因素非常多，甚至蝴蝶抖抖翅膀都引发巨大灾难。 所以复杂问题的完整刻画，其实是做不到的。</p>

<p>丁圣元（他把K线图引入中国）在谈股票的描述时，说股票市场的复杂度表述，这样的图来表达。
但也只是说，这是现实社会的极度简化，而且还说不要以为这张图就能分析纷繁复杂的现实世界。</p>

<p><img src="//s.zysr.me/img/2023-10-24/4cf494ae61fa549cdbe2d4c581bdc48.jpg" alt="4cf494ae61fa549cdbe2d4c581bdc48" style="zoom:50%;" /></p>

<p>文章说的随机性，“随机抽样”，严格说来，这是概率这个数学工具的运用。 而且计算机系统目前为止是无法产生真的随机数，无论是不是大数据，也不是使用随机来应对。</p>

<p>目前计算机使用的随机函数正式的名字是pseudorandom，准确的翻译是“伪随机数”。 也是以概率为基础来产生的。 计算机世界没有随机。但是有假的随机（伪随机）。</p>

<p>既然是基于概率的不同选择，使用不同的概率模型，自然会得出不同的结论，那柯达的选择与佳能、尼康的选择，必然会不同。<strong>概率很擅长骗人</strong>，这以及不是秘密了。</p>

<ul>
<li>不能完美刻画现实世界，也必然没有完美的计划，找不到完美的讲师和完美的课程。</li>
<li>不存在随机性，只有选择的时候倾向于选择更大概率性发生的可能。</li>
</ul>

<p>决策的更多价值在于：</p>

<ol>
<li>快速的响应（让客户聚焦在此处而不是别处）</li>
<li>问题的解决耗时短（10秒钟解决好过20秒）</li>
<li>和直观的表达（直观性上排序：文字＜声音＜图片＜视频）。</li>
</ol>

<p>三者搭在一起，就是短视频吸引人的“短、平、快” 。</p>

<p>之前和朋友聊运营，吸客的事情。也都在关注相同的点。那时的看法是：</p>

<blockquote>
  <p>时长短，拥抱用户快，内容深度上降智化、扁平化、普世化，这是短视频的精髓。 
  不是反对专业内容的存在。而是面对这样的客户画像，作出的大概率选择。</p>
</blockquote>

<p><img src="//s.zysr.me/img/2023-10-24/image-20231024200451567.png" alt="image-20231024200451567" style="zoom: 67%;" /></p>

<p><img src="//s.zysr.me/img/2023-10-24/image-20231024200513595.png" alt="image-20231024200513595" style="zoom:67%;" /></p>

<p><img src="//s.zysr.me/img/2023-10-24/image-20231024200531237.png" alt="image-20231024200531237" style="zoom:67%;" /></p>

<p><img src="//s.zysr.me/img/2023-10-24/image-20231024201054057.png" alt="image-20231024201054057" style="zoom:67%;" /></p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[清远内训之内丹秘承]]></title>
            <link href="//zysr.me//清远内训之内丹秘承_2023_10_01.html"/>
            <updated>2023-10-01T08:00:00+08:00</updated>
            <id>//zysr.me//清远内训之内丹秘承_2023_10_01.html</id>
            <content type="html"><![CDATA[]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[frp内外穿透]]></title>
            <link href="//zysr.me//FRP内外穿透_2023_08_03.html"/>
            <updated>2023-08-03T08:00:00+08:00</updated>
            <id>//zysr.me//FRP内外穿透_2023_08_03.html</id>
            <content type="html"><![CDATA[<p>NAT环境下，内网的机器是无法被外部访问到的。比如下面的LaptopA和B，都不能被公网的7.7.7.7访问到的。</p>

<p><img src="//s.zysr.me/img/2023-08-03/8683f0676f35742ff1a20342afb78f5e_nat-overview-1.png" alt="8683f0676f35742ff1a20342afb78f5e_nat-overview-1" /></p>

<p>在路由器的帮助下，才能实现双向通讯。但是大部份情况下，家用路由器不支持将Laptop暴露给外网。</p>

<p><img src="//s.zysr.me/img/2023-08-03/6b2c8bf57ab4e7ff93f6fb88dbc1dba7_nat-overview-2.png" alt="6b2c8bf57ab4e7ff93f6fb88dbc1dba7_nat-overview-2" /></p>

<p>这个时候，如果有一个服务能够直接穿透家用路由器而直接用TCP链接，把Laptop:xxxx和7.7.7.7:xxxx等效起来，那么就相当于直接把laptop暴露在公网了。</p>

<p><img src="http://s.zysr.me/img/2023-08-03/image-20230803203907612.png" alt="image-20230803203907612" /></p>

<p>而<a href="https://github.com/fatedier/frp">frp</a>则是这样的工具，能够完美的实现这个技能。在它的帮助下，能够让访问7.7.7.7:8080的时候，相当于在访问laptop:8080。</p>

<p>如果laptop:8080上面是个http服务的话，那么相当于在laptop:8080上面搭建了一个公网可以访问的web服务，只不过它的访问地址是7.7.7.7:8080。而frp更是直接内置了，一个静态的web服务器插件：static_file，可以直接提供静态文件的web服务。</p>

<p>因为laptop经常关机，所以它的应用场景只能是对可用性要求不高的环境，比如说图床，当然如果搭配公开的cloudlare这样的的CDN，那么一个月开机一次，就足够支持一般的图床应用了。</p>

<p>比如说可能是个基于laptop:8080的图床等等服务，再也不需要云空间的存储要求。</p>

<p>frp分为服务器端frps和客户端frpc，服务器端frps运行在7.7.7.7上面，客户端frpc运行在laptop上面。</p>

<p>这个体系中，frp不仅仅会监听对外服务的8080端口，而且自己也需要一个frp自己的端口用于服务器端frps和客户端frpc通讯，</p>

<p>frpc客户端与frps服务端在frp端口建立链接后，会根据客户端frpc的配制，决定如何将客户端frpc的资源暴露于7.7.7.7这个frps服务器端。所以frp服务器真正提供服务的端口，其实是由frp客户端来指定的。</p>

<p>安装之后，frpc和frps各有自己的ini格式的配置文件，启动命令非常相似</p>

<ul>
<li>frpc -c frpc.ini   #启动Laptop上面的客户端</li>
<li>frps -c frps.ini   #启动7.7.7.7上面的服务器端</li>
</ul>

<p>比如说frps.ini中，指定frps和frpc自己的通讯端口是7000.</p>

<pre><code class="hl">[common]
bind_port = 7000
</code></pre>

<p>frpc.ini</p>

<pre><code class="hl">[common]
server_addr = 7.7.7.7
server_port = 7000

[test_static_file]
type = tcp
remote_port = 8080

#这个由frp的静态服务插件来实现http静态服务，当然也可以用别的服务来实现。比如说端口转发等等。
plugin = static_file
# 要对外暴露的文件目录
plugin_local_path = C:/Documents/sites/frp_sites/pub
</code></pre>

<p>服务器和客户端启动之后，访问 http://7.7.7.7:8080，就可以直接访问Laptop上面 C:/Documents/sites/frp_sites/pub 里面的文件了。</p>

<p>比如说laptop://C:/Documents/sites/frp_sites/pub/hello.png，可以通过http://7.7.7.7:8080/hello.png来访问。</p>

<p>这个配制中，还是非常的原始，只可以适用于演示。</p>

<p>实际上上面这个配制，任何frp客户端都可以连接frps上去，这非常的不安全。所以需要在frpc和frps之间进行认证，frp支持的认证方法有token和oidc，oidc的认证略微复杂，直接使用token来设置密码最简单。</p>

<p>在上面的frps.ini和frpc.ini的common节中，同时加入：</p>

<pre><code class="hl">authentication_method = token
token = 47866af5-cc5f-4798-a658-8a39bb61f53e

</code></pre>

<p>借用电影疯狂的石头的话说，7.7.7.7:7000可不是公共厕所，想来就来 :) 。</p>

<p>这样frpc和frps就会进行连接认证了。</p>

<p>进一步的，http://7.7.7.7:8080/hello.png，这样的URL实在太丑陋了，所以Nginx做反向代理，我们新建一个站点: frp.a.com 。</p>

<p>设置DNS，将frp.a.com指向7.7.7.7之后，</p>

<p>使用http://frp.a.com/hello.png，就可以非常友好的访问laptop://C:/Documents/sites/frp_sites/pub/hello.png了。</p>

<pre><code class="hl">server {
    server_name frp.a.com;
    listen 80 ;
    location / {
        proxy_pass  http://7.7.7.7:8080;
    }
}

</code></pre>

<p>这个地方，还有点点可以改进的地方，既然http://7.7.7.7:8080/hello.png这样的网址，对外部来说已经不需要了，那么能不能换成只能Nginx内部 访问的网址，比如说 http://127.0.0.1:8080？</p>

<p>当然是可以的，这个时候需要在服务器端的frp<strong>s</strong>.ini中配制指定：</p>

<pre><code class="hl">pproxy_bind_addr = 127.0.0.1
</code></pre>

<p>这个设置，会让frp只监听127.0.0.1:8080，而不是服务器的*:8080。这样frp只接受乃至服务器本身的连接，外部不可访问7.7.7.7:8080了，就更加的安全了。</p>

<p><img src="//s.zysr.me/img/2023-08-03/image-20230803211441880.png" alt="image-20230803211441880" /></p>

<p>如果是windows，希望把frp运行在后台服务中，而不是一个丑陋的cmd黑框框，可以使用<a href="/NSSM开心服务管理工具_2023_03_06.html">nssm</a>来帮助实现</p>

<p>更多的frp服务器端和客户端配制参见：</p>

<ol>
<li><a href="https://gofrp.org/docs/reference/server-configures/">https://gofrp.org/docs/reference/server-configures/</a></li>
<li><a href="https://gofrp.org/docs/reference/client-configures/">https://gofrp.org/docs/reference/client-configures/</a></li>
</ol>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[引汉济渭]]></title>
            <link href="//zysr.me//引汉济渭_2023_07_23.html"/>
            <updated>2023-07-23T08:00:00+08:00</updated>
            <id>//zysr.me//引汉济渭_2023_07_23.html</id>
            <content type="html"><![CDATA[<p>看了个新闻，引汉济渭通水了，通水了，通水了。</p>

<p>忍不住想去黄金峡水库。黄金峡水库的地理位置在这儿</p>

<p><img src="//s.zysr.me/img/2023-07-23/7035577d6aad6df46717001b535c1e5e.jpg" alt="7035577d6aad6df46717001b535c1e5e" /></p>

<p>最终会进入陕西的供水管网，但不是自然水系。</p>

<p>去‮安西‬旅游，并不‮觉感‬缺水，是因为渭南黑河‮利水‬枢纽的暂‮性时‬缓解。</p>

<p>在‮以北岭秦‬七十二峪‮还口‬有诸‮的多‬瀑布、溪河，甚至在渭南的师门‮场道‬附近，还有山‮空色‬蒙雨亦奇‮江的‬南之色。</p>

<p><img src="//s.zysr.me/img/2023-07-23/6257084b283fa09c69ca5d0568d6fe15.jpg" alt="6257084b283fa09c69ca5d0568d6fe15" /></p>

<p>实际上，渭河平原非‮缺常‬水，很严重，西安抽取‮下地‬水严重，导致‮面地‬沉降，看看大雁塔，就快‮成变‬东方比‮斜萨‬塔，就‮道知‬有多严重。</p>

<p><img src="//s.zysr.me/img/2023-07-23/a3719eb180fcb032efe1de70406193f2.jpg" alt="a3719eb180fcb032efe1de70406193f2" /></p>

<p>陕西辖下，除了不够用的渭河，还有另外两个重要的长江支流，汉水和嘉陵江。</p>

<p>汉水，长江的一条重要支流，也称汉江，起于汉中，而汉中的归属，历史上，汉中在四川和陕西多次反复，历史原因，元代起，控汉中握秦岭以制蜀，所以汉中归陕西。</p>

<p>但是汉水却不这么认为，和嘉陵江等别的四川河流一样，不跟渭河去黄河，反而奔湖北往长江去了，没错，身在曹营心在汉，说的就是汉水。</p>

<p>实际上是因为秦岭的阻隔，汉水它去不了北方。</p>

<p>就像四川因为秦岭的阻隔很难去陕西一样，当年李白到了首都长安后，一把鼻涕一把泪的在《蜀道难》里哭闹：“尔来四万八千岁，不与秦塞通人烟”。</p>

<p>秦岭脚下‮个打‬洞，跨秦岭，把汉江水，引到缺水严‮的重‬渭河平原，这样渭河平‮的原‬西安、渭南、咸阳不‮缺再‬水了。
汉水于关中平原，功莫大焉。</p>

<p><img src="//s.zysr.me/img/2023-07-23/2be4f3ad13e469b2ac9c1471b8549135.jpg" alt="2be4f3ad13e469b2ac9c1471b8549135" /></p>

<p>进出四川的三条铁路中，成昆、宝成之外，往华东方向最近的、最险要的襄渝铁路，进入汉中后全线沿着汉水南侧大巴山脚往东走，直到进入襄阳，入武汉三镇的汉口汇入长江。</p>

<p><img src="//s.zysr.me/img/2023-07-23/c694722c6150ced5c6472cd2a7a2b61d.jpg" alt="c694722c6150ced5c6472cd2a7a2b61d" /></p>

<p>火车襄渝线进出四川，最喜欢的就是这一段风景。
沿路往北望，汉水北侧的无限秦岭风光，甚是壮美，尽收眼底。</p>

<p>如今又多了一个黄金峡水库，值得期待。</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[nginx的多证书应用]]></title>
            <link href="//zysr.me//Nginx的多证书应用_2023_07_23.html"/>
            <updated>2023-07-23T08:00:00+08:00</updated>
            <id>//zysr.me//Nginx的多证书应用_2023_07_23.html</id>
            <content type="html"><![CDATA[<p>运行多证书反向代理，充当NOSTR中继转发器快四个月了，今天准备下线这个服务。随便把配制思路分享一下。</p>

<p>NOSTR因为众所周知的原因，国内是无法访问的，而NOSTR需要中继才能存活，本来NOSTR的设计思路就是天然的</p>

<p>去中心社交模式。但是现在因为没有使用分布式方式发布和订阅中继，反而让NOSTR的分布式社交变得有名无实 了。</p>

<p>国内访问那些著名的中继器比如说wss://relay.damus.io, wss://offchain.pub等等。</p>

<p>那么如果有VPS且有域名和证书的情况下，使用Nginx是很容易架设一个反向代理服务器，充当中继转发（Forwarder of Relay）。</p>

<p>这样子，中继还是那些中继。但是因为转发器的存在，让中继器拥有了无数个“分身”。</p>

<ol>
<li>域名的申请，跳过，这个非常容易几美金就能完成的事情。</li>
<li>证书的申请，本文跳过，最简单的是使用<a href="https://certbot.eff.org/">certbot</a>来完成，但是官方的certbot手册真的很一般，很容易出错。而且它的基于域名认证的扩展也不够及时，还需要用户自己经验足够丰富。还不如使用稍为麻烦但是可靠的http文件认证模式。但是范域名证书不支持http文件认证，必须用DNS认证。好在DNS认证可以通过手</li>
</ol>

<p>这里，需要证书，是因为wss协议的要求。其实建立连接之后，Nginx还需要offload原wss请求中的Host，然后重新封装新的wss请求，然后将新的wss请求转发到中继器去。</p>

<p>同时，因为Nginx默认情况下，一般还会提供正常的https访问，所以这就要求在ssl的443端口，提供https以及中继转发的wss多个服务。为了区别这些服务，必须Nginx开启ngx_stream_ssl_preread_module模块，这个模块提供<a href="https://datatracker.ietf.org/doc/html/rfc6066#section-3">SNI</a>和<a href="https://datatracker.ietf.org/doc/html/rfc7301">ALPN</a>功能，在本文的应用场景中，只需要SNI支持，它允许客户端连接的时候，通知Ningx连接的是那个服务，是https的服务？还是wss的中继转发服务。这样Nginx就会根据客户端连接的通知，选择不同的处理逻辑：</p>

<ol>
<li>如果是wss中继转发服务，则进行wss的offload，重新组装wss请求转发到对应的中继器。这个offload主要是替换wss请求中的Host头。</li>
<li>如果是普通的https服务，则按照正常的https流程，交给本地的https应用来处理。</li>
<li>如果还有其它的服务，比如说Trojan服务那就一样的专交给Trojan服务。</li>
</ol>

<p>在这里，可以看到，其实Nginx的的处理层<strong>不是在http层来进行的，而是在strea层进行</strong>的。</p>

<p>换句话说nginx需要<strong>先配制stream块</strong>，<strong>然后配制http块</strong>。</p>

<pre><code class="hl"><br />    stream {
        log_format stream_log '$remote_addr $ssl_preread_server_name [$time_local] '
                            '$protocol $status $bytes_sent $bytes_received '
                            '$session_time "$upstream" "$upstream_addr" '
                            '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';
        access_log logs/stream.log stream_log;
        #access_log off;
        map $ssl_preread_server_name $upstream{
            ~t\.            trojan; #begin with t.xxx.yyy.. means trojan traffic
            ~\.relay\.center    relay;  #nostr relay
            default         web;
        }
    upstream trojan{
        server 127.0.0.1:8443;
    }

    upstream web{
        server 127.0.0.1:1443;
    }

    upstream relay{
        server 127.0.0.1:1443;
    }
    server {
        listen 443 reuseport;
        ssl_preread on;
        proxy_pass  $upstream;
        #proxy_ssl on;
    }
    }

</code></pre>

<p>在这里Nginx所使用到的变量<strong>$ssl_preread_server_name</strong>，就是<strong>ngx_stream_ssl_preread_module</strong>模块提供的。它通过在建立ssl连接的时候，提前读取Client Hello中的server_name来给<strong>$ssl_preread_server_name</strong>赋值，这个时候ssl的握手建立还没有完成，只是收到了客户端的hello数据包，服务器没有返回任何ssl数据包，需要根据配制逻辑，选择不同的服务器证书来完成ssl握手，然后才能进入到https层面的工作。</p>

<p>在这里根据<strong>$ssl_preread_server_name</strong>定义了不同的正则表达式，然后使用proxy_pass选择不同的后端。</p>

<pre><code class="hl">    map $ssl_preread_server_name $upstream{
        ~t\.            trojan; #begin with t.xxx.yyy.. means trojan traffic
        ~\.relay\.center    relay;  #nostr relay
        default         web;
    }
</code></pre>

<p>然后后端的配制，就使用普通的https既可，</p>

<p>中继转发的时候，需要动态的把请求代理出去既可。</p>

<p><img src="//s.zysr.me/img/2023-07-23/image-20230723100309287.png" alt="image-20230723100309287" /></p>

<p>需要注意的三个地方：</p>

<ol>
<li>客户端证书需要自己生成，很多地方都可以，openssl也应该可以</li>
<li>proxy_ssl_protocals的协议版本，最好把最新的1.3版本加上支持，否则有的服务器可能会拒绝连接，比如说damus.io</li>
<li>最后需要把普通的https升级为wss，这个用proxy_set_header指令既可完成。</li>
</ol>

<p>至于如何混用trojan流量，等有机会再说。这样子Nginx就一肩挑三担：</p>

<ol>
<li>本地的https服务</li>
<li>远程基于WSS的NOSTR中继服务器</li>
<li>Trojan流量</li>
</ol>
]]></content>
        </entry>
    </feed>